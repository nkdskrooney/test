package com.internousdev.miamiburger.action;

import java.util.List;
import java.util.Map;

import org.apache.struts2.interceptor.SessionAware;

import com.internousdev.miamiburger.dao.CartDeleteDAO;
import com.internousdev.miamiburger.dao.InsertPurchaseHistoryDAO;
import com.internousdev.miamiburger.dto.CartProductInfoDTO;
import com.internousdev.miamiburger.dto.UserInfoDTO;
import com.opensymphony.xwork2.ActionSupport;

/*
 * kessaiDTOListの内容をpurchase_history_infoテーブルへ入力する。
 * ログインユーザーのcart_infoの内容を削除する。
 */
public class SettlementCompleteAction extends ActionSupport implements SessionAware {

	Map<String,Object> session;

	public String execute(){
		InsertPurchaseHistoryDAO insertPurchaseHistoryDAO = new InsertPurchaseHistoryDAO();
		CartDeleteDAO cartDeleteDAO = new CartDeleteDAO();

		@SuppressWarnings("unchecked")
		List<CartProductInfoDTO> kessaiDTOList = (List<CartProductInfoDTO>)session.get("kessaiDTOList");

		UserInfoDTO loginDTO = (UserInfoDTO) session.get("userInfoDTO");

		for(int i = 0; i < kessaiDTOList.size(); i++){
			insertPurchaseHistoryDAO.insertPurchaseHistory(loginDTO.getUserId(), kessaiDTOList.get(i).getProductId(), kessaiDTOList.get(i).getProductCount(), kessaiDTOList.get(i).getTotalPrice());
		}

		cartDeleteDAO.deleteAllCart(loginDTO.getUserId(), "");

		return SUCCESS;
	}

	public Map<String, Object> getSession() {
		return session;
	}

	public void setSession(Map<String, Object> session) {
		this.session = session;
	}

}
